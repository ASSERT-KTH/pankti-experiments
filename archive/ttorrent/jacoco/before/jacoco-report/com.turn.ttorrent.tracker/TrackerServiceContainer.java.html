<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TrackerServiceContainer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.turn.ttorrent.tracker</a> &gt; <span class="el_source">TrackerServiceContainer.java</span></div><h1>TrackerServiceContainer.java</h1><pre class="source lang-java linenums">package com.turn.ttorrent.tracker;

import com.turn.ttorrent.common.LoggerUtils;
import com.turn.ttorrent.common.TorrentLoggerFactory;
import org.apache.commons.io.IOUtils;
import org.simpleframework.http.Request;
import org.simpleframework.http.Response;
import org.simpleframework.http.core.Container;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.OutputStream;
import java.nio.ByteBuffer;
import java.nio.channels.Channels;
import java.nio.channels.WritableByteChannel;

/**
 * @author Sergey.Pak
 * Date: 8/12/13
 * Time: 8:25 PM
 */
public class TrackerServiceContainer implements Container {

<span class="fc" id="L25">  private static final Logger logger =</span>
<span class="fc" id="L26">          TorrentLoggerFactory.getLogger(TrackerServiceContainer.class);</span>

  private TrackerRequestProcessor myRequestProcessor;
  private final MultiAnnounceRequestProcessor myMultiAnnounceRequestProcessor;

  public TrackerServiceContainer(final TrackerRequestProcessor requestProcessor,
<span class="fc" id="L32">                                 final MultiAnnounceRequestProcessor multiAnnounceRequestProcessor) {</span>
<span class="fc" id="L33">    myRequestProcessor = requestProcessor;</span>
<span class="fc" id="L34">    myMultiAnnounceRequestProcessor = multiAnnounceRequestProcessor;</span>
<span class="fc" id="L35">  }</span>

  /**
   * Handle the incoming request on the tracker service.
   * &lt;p/&gt;
   * &lt;p&gt;
   * This makes sure the request is made to the tracker's announce URL, and
   * delegates handling of the request to the &lt;em&gt;process()&lt;/em&gt; method after
   * preparing the response object.
   * &lt;/p&gt;
   *
   * @param request  The incoming HTTP request.
   * @param response The response object.
   */
  @Override
  public void handle(Request request, final Response response) {
    // Reject non-announce requests
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">    if (!Tracker.ANNOUNCE_URL.equals(request.getPath().toString())) {</span>
<span class="nc" id="L53">      response.setCode(404);</span>
<span class="nc" id="L54">      response.setText(&quot;Not Found&quot;);</span>
<span class="nc" id="L55">      return;</span>
    }

<span class="fc" id="L58">    OutputStream body = null;</span>
    try {
<span class="fc" id="L60">      body = response.getOutputStream();</span>

<span class="fc" id="L62">      response.set(&quot;Content-Type&quot;, &quot;text/plain&quot;);</span>
<span class="fc" id="L63">      response.set(&quot;Server&quot;, &quot;&quot;);</span>
<span class="fc" id="L64">      response.setDate(&quot;Date&quot;, System.currentTimeMillis());</span>

<span class="fc bfc" id="L66" title="All 2 branches covered.">      if (&quot;GET&quot;.equalsIgnoreCase(request.getMethod())) {</span>

<span class="fc" id="L68">        myRequestProcessor.process(request.getAddress().toString(), request.getClientAddress().getAddress().getHostAddress(),</span>
<span class="fc" id="L69">                getRequestHandler(response));</span>
      } else {
<span class="fc" id="L71">        myMultiAnnounceRequestProcessor.process(request.getContent(), request.getAddress().toString(),</span>
<span class="fc" id="L72">                request.getClientAddress().getAddress().getHostAddress(), getRequestHandler(response));</span>
      }
<span class="fc" id="L74">      body.flush();</span>
<span class="nc" id="L75">    } catch (IOException ioe) {</span>
<span class="nc" id="L76">      logger.info(&quot;Error while writing response: {}!&quot;, ioe.getMessage());</span>
<span class="nc" id="L77">    } catch (Throwable t) {</span>
<span class="nc" id="L78">      LoggerUtils.errorAndDebugDetails(logger, &quot;error in processing request {}&quot;, request, t);</span>
    } finally {
<span class="fc" id="L80">      IOUtils.closeQuietly(body);</span>
    }

<span class="fc" id="L83">  }</span>

  private TrackerRequestProcessor.RequestHandler getRequestHandler(final Response response) {
<span class="fc" id="L86">    return new TrackerRequestProcessor.RequestHandler() {</span>
      @Override
      public void serveResponse(int code, String description, ByteBuffer responseData) {
<span class="fc" id="L89">        response.setCode(code);</span>
<span class="fc" id="L90">        response.setText(description);</span>
        try {
<span class="fc" id="L92">          responseData.rewind();</span>
<span class="fc" id="L93">          final WritableByteChannel channel = Channels.newChannel(response.getOutputStream());</span>
<span class="fc" id="L94">          channel.write(responseData);</span>
<span class="nc" id="L95">        } catch (IOException e) {</span>
<span class="nc" id="L96">          e.printStackTrace();</span>
<span class="fc" id="L97">        }</span>
<span class="fc" id="L98">      }</span>
    };
  }

  public void setAcceptForeignTorrents(boolean acceptForeignTorrents) {
<span class="fc" id="L103">    myRequestProcessor.setAcceptForeignTorrents(acceptForeignTorrents);</span>
<span class="fc" id="L104">  }</span>

  public void setAnnounceInterval(int announceInterval) {
<span class="fc" id="L107">    myRequestProcessor.setAnnounceInterval(announceInterval);</span>
<span class="fc" id="L108">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>